<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–Ø–¥–∑–∏ (Yahtzee) - Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
     body { font-family: sans-serif; background: #2c3e50; color: #fff; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 0 auto; padding: 26px; }
    .container { max-width: 900px; margin: 0 auto; padding: 26px; }
    h1 { text-align: center; margin-bottom: 12px;}
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 8px; }
    .tab-btn {
      background: #fff; color: #2980b9; border: none; padding: 10px 32px;
      border-radius: 7px 7px 0 0; cursor: pointer; font-size: 1.05em;
      border-bottom: 2px solid #eee; margin-bottom: -2px;
      transition: background 0.2s, color 0.2s;
    }
    .tab-btn.active { background: #2980b9; color: #fff; border-bottom: 2px solid #2980b9; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .top-actions {
  display: flex;
  flex-direction: column;   /* ‚Üê —Å—Ç–∞–≤–∏–º –∫–Ω–æ–ø–∫–∏ —Å—Ç–æ–ª–±–∏–∫–æ–º */
  align-items: center;    /* –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
  gap: 8px;                 /* —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
  margin: 8px 0 14px;
}
.top-actions .btn {
  min-width: 220px;         /* —á—Ç–æ–±—ã –±—ã–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
  text-align: center;
}

/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ display */
#rules {
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
}

/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ */
#rules.tab-content.active {
  display: flex !important;
}

.rules-box {
  background: #fff;
  color: #000;
  padding: 20px 30px;
  border-radius: 10px;
  max-width: 600px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  line-height: 1.6;
}

.rules-box h2 {
  text-align: center;
  margin-bottom: 15px;
}

.rules-box ul {
  list-style: disc;
  padding-left: 20px;
}

.rules-box li {
  margin-bottom: 8px;
}

    .dice-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 18px;}
    .dice { width: 60px; height: 60px; background: #fff; color: #222; border-radius: 14px; box-shadow: 0 2px 8px #0004; display: flex; align-items: center; justify-content: center; font-size: 2.7rem; cursor: pointer; border: 3px solid transparent; transition: border 0.2s;}
    .dice.selected { border: 3px solid #27ae60;}
    .score-table { margin: 16px auto; max-width: 720px; border-collapse: collapse; background:#fff; color:#000;}
    .score-table th, .score-table td { border: 1px solid #666; padding: 7px 14px; text-align: center;}
    .score-table th { background: #34495e; color:#fff;}
    .score-table .available { cursor: pointer; background: #23aaff44;}
    .score-table .bonus { background: #39b54a99; color:#fff;}
    .upper-bonus { background:#2ecc40 !important; color:#fff !important; }
    .btn { background: #2980b9; color: #fff; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-size: 1.05rem; transition: background 0.2s;}
    .btn[disabled] { background: #666; cursor: not-allowed;}
    .turn-panel { text-align: center; margin: 13px 0 23px;}
    .msg { text-align: center; margin-bottom: 18px; font-size: 1.05rem;}
    /* --- –≤—ã–±–æ—Ä –ø–æ–ª—è –Ω–∞ –º–æ–±–∏–ª–∫–µ: –∫–Ω–æ–ø–∫–∏-¬´—á–∏–ø—Å—ã¬ª –∏ –ø–∞–Ω–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è --- */
.moves-wrap { 
  display: flex; 
  flex-wrap: wrap; 
  gap: 8px; 
  justify-content: center; 
  margin-top: 8px;
}
.moves-title { text-align:center; margin-bottom: 6px; }
.option-btn {
  background:#23aaff22; border:1px solid #23aaff66; color:#fff;
  padding:10px 12px; border-radius:10px; min-height:44px;
  cursor:pointer; font-size:1rem; user-select:none;
  touch-action:manipulation;
}
.option-btn.active { outline:3px solid #23aaff; background:#23aaff33; }
.confirm-bar{
  display:flex; gap:10px; justify-content:center; align-items:center;
  margin-top:10px; flex-wrap:wrap;
}
.confirm-bar .btn{ min-width:160px; }
.pending-chip{
  background:#fff; color:#000; padding:6px 10px; border-radius:8px;
}
    .hide { display: none; } .finish { background: #3c990f; color: #fff; padding: 24px 12px; border-radius: 16px; text-align: center; font-size: 1.5rem; margin: 20px;}
    @media (max-width: 700px) {
      .container { padding: 10px; }
      .score-table { font-size: 0.95em;}
      .dice { width: 44px; height: 44px; font-size: 1.8em;}
      .tab-btn { padding: 8px 12px; font-size: 0.95em;}
      .top-actions { justify-content:center; }
    }
    /* modal */
    #name-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:#000b;display:flex;align-items:center;justify-content:center;z-index:9999;}
    #name-modal .card {background:#fff;color:#000;padding:20px 30px;border-radius:12px;text-align:center;max-width: 90%;}
    #name-modal input {padding:10px;width:240px;font-size:1rem;}
    /* toast */
    #toast {position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); background: #000c; color: #fff; padding: 10px 14px; border-radius: 8px; display:none;}
  </style>
</head>
<body>
  <div id="toast"></div>
  <!-- –ü–æ–ø-–∞–ø –¥–ª—è "–ú–æ–¥—ã" -->
<div id="mods-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000b;display:none;align-items:center;justify-content:center;z-index:9998;">
  <div style="background:#fff;color:#000;padding:20px 24px;border-radius:12px;max-width: 520px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.3);">
    <h3 style="margin:0 0 10px;">–†–∞–∑–¥–µ–ª ¬´–ú–æ–¥—ã¬ª –µ—â—ë –≤ —Ä–∞–±–æ—Ç–µ</h3>
    <div style="font-size:0.98rem;line-height:1.5;margin-bottom:16px;text-align:left">
      <p>–ü–æ–∫–∞ –∑–¥–µ—Å—å –∏–≥—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –≤–µ—Ä—Å–∏—é ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª –µ—â—ë –Ω–µ—Ç.</p>
      <p><b>–í–∞–∂–Ω–æ:</b> —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Å—ã–≥—Ä–∞–Ω–Ω—ã–µ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ú–æ–¥—ã¬ª, <b>–≤ —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∫–æ—Ä–¥–æ–≤ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è</b>.</p>
      <p>–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ ¬´OK¬ª.</p>
    </div>
    <button class="btn" onclick="closeModsInfo()">OK</button>
  </div>
</div>
  <div id="name-modal">
    <div class="card">
      <h2>–í–≤–µ–¥–∏—Ç–µ –∏–º—è</h2>
      <input type="text" id="player-name" placeholder="–í–∞—à–µ –∏–º—è">
      <br><br>
      <button onclick="startGameWithName()" class="btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <div class="container">
    <h1>–Ø–¥–∑–∏ (Yahtzee) Web</h1>

    <div class="tabs">
  <button class="tab-btn active" data-tab="game"   onclick="showTab('game')">–ö–ª–∞—Å—Å–∏–∫–∞</button>
  <button class="tab-btn"         data-tab="mods"   onclick="showTab('mods')">–ú–æ–¥—ã</button>
  <button class="tab-btn"         data-tab="records" onclick="showTab('records')">–†–µ–∫–æ—Ä–¥—ã</button>
  <button class="tab-btn"         data-tab="rules"   onclick="showTab('rules')">–ü—Ä–∞–≤–∏–ª–∞</button>
</div>

    <div class="top-actions">
  <button id="save-btn" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
  <button id="reset-btn" class="btn">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
</div>

    <div id="game" class="tab-content active">
      <div id="round-info" class="turn-panel"></div>
      <div id="dice-row" class="dice-row"></div>
      <div style="text-align:center">
        <button id="roll-btn" class="btn">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫–∏</button>
        <div id="final-block" class="hide finish"></div>
        <span id="rolls-info" style="margin-left:18px;"></span>
      </div>
      <div id="possible-moves" class="msg"></div>
      <table class="score-table" id="score-table"></table>
      <div id="game-msg" class="msg"></div>
    </div>

    <div id="mods" class="tab-content">
  <div id="round-info-mods" class="turn-panel"></div>
  <div id="dice-row-mods" class="dice-row"></div>
  <div style="text-align:center">
    <button id="roll-btn-mods" class="btn">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫–∏</button>
    <div id="final-block-mods" class="hide finish"></div>
    <span id="rolls-info-mods" style="margin-left:18px;"></span>
  </div>
  <div id="possible-moves-mods" class="msg"></div>
  <table class="score-table" id="score-table-mods"></table>
  <div id="game-msg-mods" class="msg"></div>
</div>

    <div id="records" class="tab-content">
      <h2 style="color:#2980b9;text-align:center;">üèÜ –†–µ–∫–æ—Ä–¥—ã –∏–≥—Ä–æ–∫–æ–≤</h2>
      <div id="records-wrap" class="msg">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <div id="rules" class="tab-content">
  <div class="rules-box">
    <h2>–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
    <p><b>üéØ –¶–µ–ª—å –∏–≥—Ä—ã</b><br>
    –ù–∞–±—Ä–∞—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –æ—á–∫–æ–≤, –∑–∞–ø–æ–ª–Ω—è—è —Ç–∞–±–ª–∏—Ü—É –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞—É–Ω–¥–æ–≤.</p>

    <p><b>üïπ –•–æ–¥ –∏–≥—Ä–æ–∫–∞</b><br>
    1. –ó–∞ —Ö–æ–¥ –¥–∞—ë—Ç—Å—è –¥–æ <b>—Ç—Ä—ë—Ö –±—Ä–æ—Å–∫–æ–≤</b> –ø—è—Ç–∏ –∫—É–±–∏–∫–æ–≤.<br>
    2. –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏ –≤—Ç–æ—Ä–æ–≥–æ –±—Ä–æ—Å–∫–∞ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å, –∫–∞–∫–∏–µ –∫—É–±–∏–∫–∏ –æ—Å—Ç–∞–≤–∏—Ç—å (¬´–∑–∞–º–æ—Ä–æ–∑–∏—Ç—å¬ª), –∞ –∫–∞–∫–∏–µ –ø–µ—Ä–µ–±—Ä–æ—Å–∏—Ç—å.<br>
    3. –ü–æ—Å–ª–µ —Ç—Ä–µ—Ç—å–µ–≥–æ –±—Ä–æ—Å–∫–∞ (–∏–ª–∏ —Ä–∞–Ω—å—à–µ –ø–æ –∂–µ–ª–∞–Ω–∏—é) –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.<br>
    4. –ï—Å–ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ —Å—Ç–∞–≤–∏—Ç—Å—è <b>0</b>.</p>

    <p><b>üìä –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫</b><br>
    ‚Ä¢ <b>–ï–¥–∏–Ω–∏—Ü—ã ‚Äì –®–µ—Å—Ç—ë—Ä–∫–∏</b> ‚Äî –≤ –ø–æ–ª–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å—É–º–º–∞ –≤—Å–µ—Ö –∫—É–±–∏–∫–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —á–∏—Å–ª–æ–º.<br>
    ‚Ä¢ <b>–ë–æ–Ω—É—Å +35 –æ—á–∫–æ–≤</b> ‚Äî –¥–∞—ë—Ç—Å—è, –µ—Å–ª–∏ —Å—É–º–º–∞ –æ—á–∫–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–º –±–ª–æ–∫–µ ‚â• 63.</p>

    <p><b>üìä –ù–∏–∂–Ω–∏–π –±–ª–æ–∫</b><br>
    ‚Ä¢ <b>–ü–∞—Ä–∞</b> ‚Äî —Ö–æ—Ç—è –±—ã –¥–≤–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö. –û—á–∫–∏: —Å—É–º–º–∞ –≤—Å–µ—Ö –∫—É–±–∏–∫–æ–≤.<br>
    ‚Ä¢ <b>–î–≤–µ –ø–∞—Ä—ã</b> ‚Äî –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä—ã, –∏–ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–≤–µ –ø–∞—Ä—ã (–∫–∞—Ä–µ –∏–ª–∏ –Ø–¥–∑–∏). –û—á–∫–∏: —Å—É–º–º–∞ –≤—Å–µ—Ö –∫—É–±–∏–∫–æ–≤.<br>
    ‚Ä¢ <b>–°–µ—Ç (—Ç—Ä–æ–π–∫–∞)</b> ‚Äî —Ç—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö. –û—á–∫–∏: —Å—É–º–º–∞ –≤—Å–µ—Ö –∫—É–±–∏–∫–æ–≤.<br>
    ‚Ä¢ <b>–ö–∞—Ä–µ (—á–µ—Ç–≤—ë—Ä–∫–∞)</b> ‚Äî —á–µ—Ç—ã—Ä–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö. –û—á–∫–∏: —Å—É–º–º–∞ –≤—Å–µ—Ö –∫—É–±–∏–∫–æ–≤.<br>
    ‚Ä¢ <b>–§—É–ª–ª-—Ö–∞—É—Å</b> ‚Äî —Ç—Ä–æ–π–∫–∞ + –ø–∞—Ä–∞. –û—á–∫–∏: 25.<br>
    ‚Ä¢ <b>–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç</b> ‚Äî —á–µ—Ç—ã—Ä–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–ª–∞ (1-2-3-4, 2-3-4-5, 3-4-5-6). –û—á–∫–∏: 30.<br>
    ‚Ä¢ <b>–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç</b> ‚Äî –ø—è—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª (1-2-3-4-5 –∏–ª–∏ 2-3-4-5-6). –û—á–∫–∏: 40.<br>
    ‚Ä¢ <b>–Ø–¥–∑–∏</b> ‚Äî –ø—è—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö. –û—á–∫–∏: 50.<br>
    ‚Ä¢ <b>–®–∞–Ω—Å</b> ‚Äî –ª—é–±—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è. –û—á–∫–∏: —Å—É–º–º–∞ –≤—Å–µ—Ö –∫—É–±–∏–∫–æ–≤.</p>

    <p><b>üèÜ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏</b><br>
    ‚Ä¢ –ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –æ—á–∫–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–æ–≤.<br>
    ‚Ä¢ –ü–æ–±–µ–∂–¥–∞–µ—Ç –∏–≥—Ä–æ–∫ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π —Å—É–º–º–æ–π.<br>
    ‚Ä¢ –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø–∞—Ä—Ç–∏–∏ –º–æ–≥—É—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–∞—É–Ω–¥–æ–≤, –∞ –æ–±—â–∞—è —Å—É–º–º–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –≤—Å–µ–º —Ä–∞—É–Ω–¥–∞–º.</p>

    <div style="margin-top:20px; text-align:center;">
  <p><b>–ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–ª–∏—Å—å —Å–ª–æ–∂–Ω—ã–º–∏ –∏–ª–∏ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä –ø–∞—Ä—Ç–∏–∏:</b></p>
</div>

    <!-- –í–∏–¥–µ–æ -->
    <div style="margin-top:20px; position:relative; padding-bottom:56.25%; height:0; overflow:hidden;">
  <iframe src="https://vkvideo.ru/video_ext.php?oid=-203677279&id=456241703&hash=304a57eca49b6a00"
          style="position:absolute; top:0; left:0; width:100%; height:100%;"
          frameborder="0" allowfullscreen="1"
          allow="autoplay; encrypted-media; fullscreen; picture-in-picture">
  </iframe>
</div>


  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  

<script>
// --- Tabs + –∞–∫—Ç–∏–≤–Ω–∞—è –∏–≥—Ä–∞ ---
let activeGame = null;
let modsInfoShown = false; // —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –ø–æ–∫–∞–∑–∞–ª–∏ –ø–æ–ø–∞–ø —É–∂–µ –∏–ª–∏ –Ω–µ—Ç

function openModsInfo() {
  const el = document.getElementById('mods-modal');
  if (el) el.style.display = 'flex';
}
function closeModsInfo() {
  const el = document.getElementById('mods-modal');
  if (el) el.style.display = 'none';
}
function showTab(tab) {
  // 1) –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

  // 2) –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  const panel = document.getElementById(tab);
  if (panel) panel.classList.add('active');

  // 3) –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
  const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if (btn) btn.classList.add('active');

  // 4) –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º ¬´–∞–∫—Ç–∏–≤–Ω—É—é –∏–≥—Ä—É¬ª (–µ—Å–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã)
  if (tab === 'game' && window.classicGame) {
    activeGame = window.classicGame;
  } else if (tab === 'mods' && window.modsGame) {
    activeGame = window.modsGame;
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø‚Äë–∞–ø —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é
    if (!modsInfoShown && typeof openModsInfo === 'function') {
      openModsInfo();
      modsInfoShown = true;
    }
  }

  // 5) –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ ¬´–†–µ–∫–æ—Ä–¥—ã¬ª ‚Äî –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–∏–º —Ä–µ–∫–æ—Ä–¥–æ–≤
  if (tab === 'records' && typeof ensureLeaderboardSubscribed === 'function') {
    ensureLeaderboardSubscribed();
  }
}

function showTab(tab) {
  // 1) –°–Ω—è—Ç—å active —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –≤–∫–ª–∞–¥–æ–∫
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

  // 2) –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  const panel = document.getElementById(tab);
  if (panel) panel.classList.add('active');

  // 3) –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É
  const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if (btn) btn.classList.add('active');

  // 4) –°–ø–µ—Ü‚Äë–ª–æ–≥–∏–∫–∞: –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –≤ "–ú–æ–¥—ã" ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ø–∞–ø –æ–¥–∏–Ω —Ä–∞–∑
  if (tab === 'mods' && !modsInfoShown) {
    openModsInfo();
    modsInfoShown = true;
  }

  // 5) –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ "–†–µ–∫–æ—Ä–¥—ã" ‚Äî –ø–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
  if (tab === 'records' && typeof ensureLeaderboardSubscribed === 'function') {
    ensureLeaderboardSubscribed();
  }
}

// ---------- –û–±—â–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ----------
const upperFields = ["1", "2", "3", "4", "5", "6"];
const lowerFields = ["–ü–∞—Ä–∞","–î–≤–µ –ø–∞—Ä—ã","–°–µ—Ç","–ö–∞—Ä–µ","–§—É–ª–ª —Ö–∞—É—Å","–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç","–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç","–Ø–¥–∑–∏","–®–∞–Ω—Å"];
const allFields = [...upperFields, ...lowerFields];

function randomDice(){ return Math.floor(Math.random()*6)+1; }
function diceEmoji(v){ return ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][v-1]; }
function countDice(a){ const c={1:0,2:0,3:0,4:0,5:0,6:0}; for(const d of a) c[d]++; return c; }

function possibleScores(dice, table) {
  const d = countDice(dice);
  const res = {};

  // –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫
  for (const f of upperFields) {
    if (table[f] === null) res[f] = d[+f] * (+f);
  }

  // –ü–∞—Ä–∞
  if (table["–ü–∞—Ä–∞"] === null) {
    res["–ü–∞—Ä–∞"] = 0;
    for (let i = 6; i >= 1; i--) {
      if (d[i] >= 2) { res["–ü–∞—Ä–∞"] = dice.reduce((a,b)=>a+b,0); break; }
    }
  }

  // –î–≤–µ –ø–∞—Ä—ã ‚Äî –∫–∞—Ä–µ/–Ø–¥–∑–∏ —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ –¥–≤–µ –ø–∞—Ä—ã
  if (table["–î–≤–µ –ø–∞—Ä—ã"] === null) {
    const pairCount = Object.values(d).reduce((sum, c) => sum + Math.floor(c / 2), 0);
    res["–î–≤–µ –ø–∞—Ä—ã"] = pairCount >= 2 ? dice.reduce((a,b)=>a+b,0) : 0;
  }

  // –°–µ—Ç
  if (table["–°–µ—Ç"] === null) {
    res["–°–µ—Ç"] = 0;
    for (let i = 6; i >= 1; i--) {
      if (d[i] >= 3) { res["–°–µ—Ç"] = dice.reduce((a,b)=>a+b,0); break; }
    }
  }

  // –ö–∞—Ä–µ
  if (table["–ö–∞—Ä–µ"] === null) {
    res["–ö–∞—Ä–µ"] = 0;
    for (let i = 6; i >= 1; i--) {
      if (d[i] >= 4) { res["–ö–∞—Ä–µ"] = dice.reduce((a,b)=>a+b,0); break; }
    }
  }

  // –§—É–ª–ª —Ö–∞—É—Å
  if (table["–§—É–ª–ª —Ö–∞—É—Å"] === null) {
    let has3 = false, has2 = false;
    for (let i = 1; i <= 6; i++) {
      if (d[i] === 3) has3 = true;
      else if (d[i] === 2) has2 = true;
    }
    res["–§—É–ª–ª —Ö–∞—É—Å"] = (has3 && has2) ? 25 : 0;
  }

  // –ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç
  if (table["–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç"] === null) {
    const u = [...new Set(dice)].sort((a,b)=>a-b);
    const has = [[1,2,3,4],[2,3,4,5],[3,4,5,6]].some(seq => seq.every(x => u.includes(x)));
    res["–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç"] = has ? 30 : 0;
  }

  // –ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç
  if (table["–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç"] === null) {
    const has = [1,2,3,4,5].every(x => dice.includes(x)) ||
                [2,3,4,5,6].every(x => dice.includes(x));
    res["–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç"] = has ? 40 : 0;
  }

  // –Ø–¥–∑–∏
  if (table["–Ø–¥–∑–∏"] === null) {
    res["–Ø–¥–∑–∏"] = Object.values(d).includes(5) ? 50 : 0;
  }

  // –®–∞–Ω—Å
  if (table["–®–∞–Ω—Å"] === null) {
    res["–®–∞–Ω—Å"] = dice.reduce((a,b)=>a+b,0);
  }

  return res;
}
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å ¬´–≥—Ä—É–±—ã–º¬ª —É–∫–∞–∑–∞—Ç–µ–ª–µ–º (–æ–±—ã—á–Ω–æ —Ç–∞—á)
function isCoarsePointer(){
  return window.matchMedia && window.matchMedia('(pointer:coarse)').matches;
}


// ---------- –ö–ª–∞—Å—Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –æ–¥–Ω–æ–π –∏–≥—Ä—ã ----------
function GameController(suffix) {
  // suffix: '' –¥–ª—è "–ò–≥—Ä–∞", '-mods' –¥–ª—è "–ú–æ–¥—ã"
  this.suffix = suffix;

  this.round = 1;
  this.rollsLeft = 3;
  this.dice = [1,1,1,1,1];
  this.diceKeep = [false,false,false,false,false];
  this.roundScoreTables = [{}, {}, {}];
  this.scoreTable = {};
  this.resetScoreTable = () => { this.scoreTable = {}; for (const f of allFields) this.scoreTable[f]=null; };

  const gid = (base) => document.getElementById(base + this.suffix);
  this.elRoundInfo = gid('round-info');
  this.elDiceRow   = gid('dice-row');
  this.elRollBtn   = gid('roll-btn');
  this.elFinal     = gid('final-block');
  this.elRollsInfo = gid('rolls-info');
  this.elMoves     = gid('possible-moves');
  this.elTable     = gid('score-table');
  this.elMsg       = gid('game-msg');
    // –í—ã–±–æ—Ä –ø–æ–ª—è –Ω–∞ —Ç–∞—á–µ: —á—Ç–æ —Å–µ–π—á–∞—Å ¬´–ø–æ–¥—Å–≤–µ—á–µ–Ω–æ¬ª, –Ω–æ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
  this.pendingField = null;


  this.drawDiceRow = () => {
    this.elDiceRow.innerHTML = '';
    for (let i=0;i<5;i++){
      const d = document.createElement('div');
      d.className = 'dice' + (this.diceKeep[i] ? ' selected' : '');
      d.innerHTML = diceEmoji(this.dice[i]);
      d.onclick = () => {
        if (this.rollsLeft<3 && this.rollsLeft>0) {
          this.diceKeep[i] = !this.diceKeep[i];
          this.drawDiceRow();
        }
      };
      this.elDiceRow.appendChild(d);
    }
  };

  this.animateRoll = (cb) => {
    let t=10;
    const int=setInterval(()=>{
      for (let i=0;i<5;i++) if(!this.diceKeep[i]) this.dice[i]=randomDice();
      this.drawDiceRow();
      if(--t==0){ clearInterval(int); cb&&cb(); }
    },60);
  };

   this.showPossibleMoves = (poss) => {
    const arr = Object.entries(poss).filter(([k])=>this.scoreTable[k]===null);
    if (!arr.length) { this.elMoves.innerHTML=''; return; }

    // –î–µ—Å–∫—Ç–æ–ø ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä (span)
if (!isCoarsePointer()) {
  let html = "<b>–í—ã–±–µ—Ä–∏ –∫—É–¥–∞ –∑–∞–ø–∏—Å–∞—Ç—å:</b> ";
  html += arr.map(([k,v]) => 
    `<span class="available" onclick="window.__choose('${this.suffix}','${k}')">${k} <b>(${v})</b></span>`
  ).join(' | ');
  this.elMoves.innerHTML = html;
  return;
}

// –¢–∞—á ‚Äî —Ç–∞–∫–∏–µ –∂–µ —á–∏–ø—Å—ã, –Ω–æ –∫–ª–∏–∫ —Å—Ä–∞–∑—É –ø–∏—à–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
const options = arr.map(([k,v]) =>
  `<button class="option-btn" onclick="window.__choose('${this.suffix}','${k}')">${k} <b>(${v})</b></button>`
).join('');

this.elMoves.innerHTML = `
  <div class="moves-title"><b>–í—ã–±–µ—Ä–∏ –∫—É–¥–∞ –∑–∞–ø–∏—Å–∞—Ç—å:</b></div>
  <div class="moves-wrap">${options}</div>
`;

  };
  this.hidePossibleMoves = () => { this.elMoves.innerHTML = ''; };

  this.chooseField = (field) => {
    const poss = possibleScores(this.dice, this.scoreTable);
    if (this.scoreTable[field]!==null) return;
    this.scoreTable[field] = poss[field];
    this.roundScoreTables[this.round-1][field] = poss[field];

    this.drawTable();
    this.hidePossibleMoves();

    const finished = allFields.every(f => this.scoreTable[f]!==null);
    this.rollsLeft = 3;
    this.diceKeep = [false,false,false,false,false];
    this.elRollBtn.disabled = false;
    this.elRollsInfo.innerHTML = "";
    this.elMsg.innerHTML = "";
    this.drawDiceRow();

    if (finished) {
      this.elMsg.innerHTML = `<b>–†–∞—É–Ω–¥ ${this.round} –∑–∞–≤–µ—Ä—à—ë–Ω!</b>`;
      setTimeout(()=>{
        if (this.round < 3) { this.round++; this.startRound(); }
        else { this.showFinal(); }
      },1200);
    }
  };

  this.drawTable = () => {
    let html = `<tr><th>–ü–æ–ª–µ</th><th>–†–∞—É–Ω–¥ 1</th><th>–†–∞—É–Ω–¥ 2</th><th>–†–∞—É–Ω–¥ 3</th></tr>`;
    html += `<tr><th colspan="4">–í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫</th></tr>`;

    const upperSums = [0,0,0];

    for (const f of upperFields) {
      html += `<tr><td>${f}</td>`;
      for (let r=0;r<3;r++){
        const v = this.roundScoreTables[r][f] ?? "";
        if (v !== "") upperSums[r] += v;
        html += `<td${r+1===this.round?' style="background:#2ecc4022;"':''}>${v}</td>`;
      }
      html += `</tr>`;

      if (f === '6') {
        html += `<tr>
          <td><b>–°—É–º–º–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞</b></td>
          <td class="${upperSums[0] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[0]}</b></td>
          <td class="${upperSums[1] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[1]}</b></td>
          <td class="${upperSums[2] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[2]}</b></td>
        </tr>`;

        html += `<tr>
          <td><b>–ë–æ–Ω—É—Å (+35, –µ—Å–ª–∏ ‚â•63)</b></td>
          <td class="bonus">${upperSums[0] >= 63 ? 35 : ''}</td>
          <td class="bonus">${upperSums[1] >= 63 ? 35 : ''}</td>
          <td class="bonus">${upperSums[2] >= 63 ? 35 : ''}</td>
        </tr>`;

        const lower = [0,0,0];
        for (let r=0;r<3;r++)
          for (const ff of lowerFields)
            lower[r] += (this.roundScoreTables[r][ff] ?? 0);

        html += `<tr>
          <td><b>–°—É–º–º–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞</b></td>
          <td><b>${lower[0]}</b></td>
          <td><b>${lower[1]}</b></td>
          <td><b>${lower[2]}</b></td>
        </tr>`;
      }
    }

    html += `<tr><th colspan="4">–ù–∏–∂–Ω–∏–π –±–ª–æ–∫</th></tr>`;
    for (const f of lowerFields) {
      html += `<tr><td>${f}</td>`;
      for (let r=0;r<3;r++){
        const v = this.roundScoreTables[r][f] ?? "";
        html += `<td${r+1===this.round?' style="background:#2ecc4022;"':''}>${v}</td>`;
      }
      html += `</tr>`;
    }

    html += `<tr><td><b>–ò—Ç–æ–≥–æ –∑–∞ —Ä–∞—É–Ω–¥</b></td>`;
    const roundTotals = [];
    for (let r=0;r<3;r++){
      let s=0;
      for (const f of allFields) s += (this.roundScoreTables[r][f] || 0);
      if (upperSums[r] >= 63) s += 35;
      roundTotals[r] = s;
      html += `<td><b>${s || ""}</b></td>`;
    }
    html += `</tr>`;

    const totalAll = roundTotals.reduce((a,b)=>a+b,0);
    const remain = Math.max(bestScore - totalAll, 0);
    let extra = '';
    if (bestScore > 0) {
      extra = remain > 0
        ? `<div style="font-weight:normal;font-size:0.95em;color:#2980b9;margin-top:6px;">
             –û—Å—Ç–∞–ª–æ—Å—å –¥–æ —Ä–µ–∫–æ—Ä–¥–∞: <b>${remain}</b> (—Ä–µ–∫–æ—Ä–¥: ${bestScore})
           </div>`
        : (totalAll > 0
            ? `<div style="font-weight:normal;font-size:0.95em;color:#27ae60;margin-top:6px;">
                 –≠—Ç–æ <b>—Ä–µ–∫–æ—Ä–¥!</b> (—Å—Ç–∞—Ä—ã–π: ${bestScore})
               </div>`
            : '');
    }
    html += `<tr>
      <td><b>–°—É–º–º–∞ –≤—Å–µ–≥–æ</b></td>
      <td colspan="3"><b>${totalAll}</b>${extra}</td>
    </tr>`;

    this.elTable.innerHTML = html;
  };

  this.startRound = () => {
    this.resetScoreTable();
    this.rollsLeft = 3;
    this.dice = [1,1,1,1,1];
    this.diceKeep = [false,false,false,false,false];

    this.elFinal.classList.add('hide');
    this.elRoundInfo.innerHTML = `<b>–†–∞—É–Ω–¥ ${this.round} –∏–∑ 3</b>`;
    this.elMsg.innerHTML = "";
    this.drawDiceRow();
    this.drawTable();
    this.hidePossibleMoves();
    this.elRollBtn.disabled = false;
    this.elRollsInfo.innerHTML = '–ë—Ä–æ—Å–∫–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: <b>3</b>';
  };

  this.getCurrentTotal = () => {
    const upper=[0,0,0];
    for (let r=0;r<3;r++) for (const f of upperFields) upper[r]+=this.roundScoreTables[r][f]??0;
    const totals=[];
    for (let r=0;r<3;r++){
      let s=0;
      for (const f of allFields) s+=this.roundScoreTables[r][f]||0;
      if (upper[r]>=63) s+=35;
      totals[r]=s;
    }
    return totals.reduce((a,b)=>a+b,0);
  };

  this.showFinal = () => {
    const total = this.getCurrentTotal();
    let message = "";

    if (total >= 777) {
      message = `üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> üéâ<br>
                 –¢—ã –Ω–∞–±—Ä–∞–ª <b>${total}</b> –æ—á–∫–æ–≤.`;

      if (total > 1030) {
        message += `<br>üëë –¢—ã –≤ <b>–ø—Ä–∞–π–º–µ</b>! –ï—â—ë —á—É—Ç—å-—á—É—Ç—å ‚Äî –∏ —Ç—ã –æ–±–≥–æ–Ω–∏—à—å –õ–µ–Ω—É! üî•`;
      } else if (total > 950) {
        message += `<br>üî• –î–∞ —Ç—ã –Ω–∞—Å—Ç–æ—è—â–∏–π <b>–∑–∞–¥—Ä–æ—Ç</b> ‚Äî —Å—Ç–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤! –í–∞—É! üî•`;
      }

      message += `<br><br><b>–ù–µ –∑–∞–±—É–¥—å –Ω–∞–∂–∞—Ç—å ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª (–∫–Ω–æ–ø–∫–∞ –≤–≤–µ—Ä—Ö—É).</b>`;
    } else {
      message = `üò¢ <b>–£–≤—ã!</b> –¢—ã –Ω–∞–±—Ä–∞–ª <b>${total}</b> –æ—á–∫–æ–≤.<br>
                 –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º <b>777</b> –æ—á–∫–æ–≤.<br>
                 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç 777 –∏ –≤—ã—à–µ.`;
    }

    this.elFinal.classList.remove('hide');
    this.elFinal.innerHTML = `
      <div>
        ${message}
        <br><br>
        <button class="btn" onclick="window.__restart('${this.suffix}')">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      </div>
    `;
    ensureLeaderboardSubscribed();
  };

  this.restartGame = () => { this.round=1; this.roundScoreTables=[{},{},{}]; this.startRound(); };

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—Ä–æ—Å–∫–æ–≤ ‚Äî –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å–≤–æ–µ–π –∫–Ω–æ–ø–∫–µ
  this.elRollBtn.onclick = () => {
    if (this.rollsLeft>0){
      this.elRollBtn.disabled = true;
      this.animateRoll(()=>{
        this.rollsLeft--;
        this.elRollBtn.disabled = (this.rollsLeft==0);
        this.elRollsInfo.innerHTML = `–ë—Ä–æ—Å–∫–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: <b>${this.rollsLeft}</b>`;
        if (this.rollsLeft==0){
          this.showPossibleMoves(possibleScores(this.dice, this.scoreTable));
          this.elMsg.innerHTML = '–í—ã–±–µ—Ä–∏ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.';
        } else {
          this.elMsg.innerHTML = '–í—ã–¥–µ–ª–∏ –∫—É–±–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞—Ç—å, –∑–∞—Ç–µ–º —Å–Ω–æ–≤–∞ –±—Ä–æ—Å–∞–π.';
        }
      });
    }
  };
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ–º–æ—â–Ω–∏–∫–∏ –¥–ª—è inline onclick (–≤ —Ç–∞–±–ª–∏—Ü–µ/–∫–Ω–æ–ø–∫–µ ¬´—Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞¬ª)
window.__choose = (suffix, field) => {
  const g = (suffix==='' ? classicGame : modsGame);
  g.chooseField(field);
};
window.__restart = (suffix) => {
  const g = (suffix==='' ? classicGame : modsGame);
  g.restartGame();
};
window.__selectOption = (suffix, field) => {
  const g = (suffix==='' ? classicGame : modsGame);
  g.pendingField = field;
  // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º –ø–∞–Ω–µ–ª—å —Ö–æ–¥–æ–≤ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
  g.showPossibleMoves(possibleScores(g.dice, g.scoreTable));
};

window.__confirmOption = (suffix) => {
  const g = (suffix==='' ? classicGame : modsGame);
  if (!g.pendingField) return;
  const field = g.pendingField;
  g.pendingField = null;
  g.chooseField(field);
};

window.__cancelOption = (suffix) => {
  const g = (suffix==='' ? classicGame : modsGame);
  g.pendingField = null;
  // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
  g.showPossibleMoves(possibleScores(g.dice, g.scoreTable));
};

// ---------- –ò–º—è –∏–≥—Ä–æ–∫–∞ ----------
let playerName = "";
function startGameWithName(){
  const v = document.getElementById('player-name').value.trim();
  if (!v) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!'); return; }
  playerName = v;
  document.getElementById('name-modal').style.display='none';
  // —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏–º –æ–±–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
  classicGame.startRound();
  modsGame.startRound();
  // –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥–µ—Ç –≤–∫–ª–∞–¥–∫–∞ "–ò–≥—Ä–∞"
  activeGame = classicGame;
}

// ---------- Firebase setup (compat) ----------
const firebaseConfig = {
  apiKey: "AIzaSyDJX6EdXi_24H80N0WPfdHjmMZ97xRjuQQ",
  authDomain: "yadzee-a6b2b.firebaseapp.com",
  databaseURL: "https://yadzee-a6b2b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "yadzee-a6b2b",
  storageBucket: "yadzee-a6b2b.appspot.com",
  messagingSenderId: "67079856385",
  appId: "1:67079856385:web:cbc043ecfa6081b9983b00",
  measurementId: "G-G3HHBM8BF1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- –†–µ–∫–æ—Ä–¥ (–¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ "–æ—Å—Ç–∞–ª–æ—Å—å –¥–æ —Ä–µ–∫–æ—Ä–¥–∞") ---
let bestScore = 0;
function subscribeBestScore() {
  const top1Ref = db.ref('scores').orderByChild('score').limitToLast(1);
  top1Ref.on('value', (snap) => {
    let max = 0;
    snap && snap.forEach(ch => {
      const v = (ch.val().score | 0);
      if (v > max) max = v;
    });
    bestScore = max;
    // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ —É–∂–µ –≤—ã–≤–µ–¥–µ–Ω—ã
    if (document.getElementById('score-table')?.innerHTML) classicGame.drawTable();
    if (document.getElementById('score-table-mods')?.innerHTML) modsGame.drawTable();
  });
}
subscribeBestScore();

// ---------- –¢–æ—Å—Ç—ã ----------
function showToast(text){
  const t=document.getElementById('toast');
  t.textContent=text; t.style.display='block';
  setTimeout(()=>t.style.display='none',1800);
}

// ---------- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ–±—â–∞—è –∫–Ω–æ–ø–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É) ----------
async function saveScoreToFirebase(name, score){
  // –ü–æ—Ä–æ–≥: –º–µ–Ω—å—à–µ 777 ‚Äî –Ω–µ –ø–∏—à–µ–º
  if ((score|0) < 777) {
    showToast('–í —Ä–µ–∫–æ—Ä–¥—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç 777 –æ—á–∫–æ–≤.');
    return;
  }
  const payload = { name, score, ts: Date.now() };
  try {
    await db.ref('scores').push(payload);
    showToast('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
  } catch(e) {
    console.error('saveScore error', e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ø—Ä–∞–≤–∏–ª–∞ –ë–î.');
  }
}

document.getElementById('save-btn').addEventListener('click', async ()=>{
  // ‚Üê –î–û–ë–ê–í–¨ –≠–¢–û
  const modsTabOpen = document.getElementById('mods')?.classList.contains('active');
  if (modsTabOpen) {
    showToast('–†–µ–∂–∏–º ¬´–ú–æ–¥—ã¬ª: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–æ.');
    return;
  }

  let name = playerName;
  if (!name) {
    name = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞:');
    if (!name) return;
    playerName = name;
    document.getElementById('name-modal').style.display='none';
  }

  const current = activeGame.getCurrentTotal();
  if (current <= 0) { showToast('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∏–≥—Ä–∞–π –æ—á–∫–∏ :)'); return; }
  await saveScoreToFirebase(name, current);
});

// ---------- –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –∏–≥—Ä–∞" ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É ----------
document.getElementById('reset-btn').addEventListener('click', () => {
  if (!activeGame) { showToast('–û—Ç–∫—Ä–æ–π –≤–∫–ª–∞–¥–∫—É —Å –∏–≥—Ä–æ–π.'); return; }
  if (!confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) return;
  activeGame.restartGame();
});

// ---------- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ ----------
let scoresSubscribed = false;
function ensureLeaderboardSubscribed(){
  if (scoresSubscribed) return;
  scoresSubscribed = true;

  const ref = db.ref('scores').limitToLast(200);
  const wrap = document.getElementById('records-wrap');
  wrap.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

  ref.on('value', (snap) => {
    const list = [];
    if (snap && snap.exists()) {
      snap.forEach((child) => { list.push(child.val()); });
    }
    list.sort((a,b) => (b.score|0) - (a.score|0) || (a.ts||0) - (b.ts||0));
    renderLeaderboard(list.slice(0, 20));
  }, (err)=>{
    console.error('leaderboard error', err);
    wrap.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤: ' + err.message;
  });
}

function renderLeaderboard(rows){
  const wrap = document.getElementById('records-wrap');
  if (!rows || rows.length === 0) {
    wrap.innerHTML = '–ï—â—ë –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—ã–º!';
    return;
  }

  let html = "<table class='score-table'><tr><th>–ú–µ—Å—Ç–æ</th><th>–ò–º—è</th><th>–û—á–∫–∏</th><th>–î–∞—Ç–∞</th></tr>";

  // –õ–æ–≥–∏–∫–∞ ¬´competition ranking¬ª: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –æ—á–∫–∏ ‚Üí –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –º–µ—Å—Ç–æ,
  // —Å–ª–µ–¥—É—é—â–µ–µ –º–µ—Å—Ç–æ = –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —É–∂–µ –≤—ã–≤–µ–¥–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫.
  let prevScore = null;     // –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—á—ë—Ç
  let rank = 0;             // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –º–µ—Å—Ç–æ
  let processed = 0;        // —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ —É–∂–µ –≤—ã–≤–µ–¥–µ–Ω–æ (1..N)

  rows.forEach((r) => {
    processed++;
    const score = (r.score | 0);

    if (prevScore === null) {
      rank = 1; // –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤—Å–µ–≥–¥–∞ 1 –º–µ—Å—Ç–æ
    } else if (score !== (prevScore | 0)) {
      // –Ω–æ–≤—ã–π —Å—á—ë—Ç –º–µ–Ω—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ ‚Äî –º–µ—Å—Ç–æ = –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
      rank = processed;
    }
    prevScore = score;

    const when = r.ts ? new Date(r.ts).toLocaleString() : '';
    html += `<tr>
      <td>${rank}</td>
      <td>${escapeHtml(r.name || '')}</td>
      <td>${score}</td>
      <td>${when}</td>
    </tr>`;
  });

  html += "</table>";
  wrap.innerHTML = html;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// ---------- –°–æ–∑–¥–∞—ë–º –¥–≤–µ –∏–≥—Ä—ã ----------
const classicGame = new GameController('');      // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç id –±–µ–∑ —Å—É—Ñ—Ñ–∏–∫—Å–∞
const modsGame    = new GameController('-mods'); // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç id —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º -mods
</script>
</body>
</html>