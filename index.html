<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–Ø–¥–∑–∏ (Yahtzee) - Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; background: #2c3e50; color: #fff; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 0 auto; padding: 30px; }
    h1 { text-align: center; margin-bottom: 12px;}
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 18px; }
    .tab-btn { background: #fff; color: #2980b9; border: none; padding: 10px 32px;
      border-radius: 7px 7px 0 0; cursor: pointer; font-size: 1.1em;
      border-bottom: 2px solid #eee; margin-bottom: -2px; transition: background .2s, color .2s; }
    .tab-btn.active { background: #2980b9; color: #fff; border-bottom: 2px solid #2980b9; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .dice-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 18px;}
    .dice { width: 60px; height: 60px; background: #fff; color: #222; border-radius: 14px; box-shadow: 0 2px 8px #0004;
      display: flex; align-items: center; justify-content: center; font-size: 2.7rem; cursor: pointer; border: 3px solid transparent; transition: border .2s;}
    .dice.selected { border: 3px solid #27ae60;}
    .score-table { margin: 16px auto; max-width: 600px; border-collapse: collapse; background:#fff; color:#000;}
    .score-table th, .score-table td { border: 1px solid #666; padding: 7px 14px; text-align: center;}
    .score-table th { background: #34495e; color:#fff;}
    .score-table .available { cursor: pointer; background: #23aaff44;}
    .score-table .used { background: #424242;}
    .score-table .bonus { background: #39b54a99; color:#fff;}
    .btn { background: #2980b9; color: #fff; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; transition: background .2s;}
    .btn[disabled] { background: #666; cursor: not-allowed;}
    .turn-panel { text-align: center; margin: 13px 0 23px;}
    .msg { text-align: center; margin-bottom: 18px; font-size: 1.1rem;}
    .hide { display: none; }
    .finish { background: #3c990f; color: #fff; padding: 24px 12px; border-radius: 16px; text-align: center; font-size: 1.5rem; margin: 20px;}

    /* –∑–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—É–º–º—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ –ø—Ä–∏ –±–æ–Ω—É—Å–µ */
    .upper-bonus { background:#2ecc40 !important; color:#fff !important; }

    @media (max-width: 700px) {
      .container { padding: 6px; }
      .score-table { font-size: 0.95em;}
      .dice { width: 40px; height: 40px; font-size: 1.6em;}
      .tab-btn { padding: 8px 12px; font-size: 0.95em;}
    }

    /* –º–æ–¥–∞–ª–∫–∞ –∏–º–µ–Ω–∏ */
    #name-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:#000b;display:flex;align-items:center;justify-content:center;z-index:9999;}
    #name-modal .card {background:#fff;color:#000;padding:20px 30px;border-radius:12px;text-align:center;max-width: 90%;}
    #name-modal input {padding:10px;width:240px;font-size:1rem;}
  </style>
</head>
<body>
  <!-- –ò–º—è –∏–≥—Ä–æ–∫–∞ -->
  <div id="name-modal">
    <div class="card">
      <h2>–í–≤–µ–¥–∏—Ç–µ –∏–º—è</h2>
      <input type="text" id="player-name" placeholder="–í–∞—à–µ –∏–º—è">
      <br><br>
      <button onclick="startGameWithName()" class="btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <div class="container">
    <h1>–Ø–¥–∑–∏ (Yahtzee) Web</h1>
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('game')">–ò–≥—Ä–∞</button>
      <button class="tab-btn" onclick="showTab('records')">–†–µ–∫–æ—Ä–¥—ã</button>
    </div>

    <div id="game" class="tab-content active">
      <div id="round-info" class="turn-panel"></div>
      <div id="dice-row" class="dice-row"></div>
      <div style="text-align:center">
        <button id="roll-btn" class="btn">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫–∏</button>
        <span id="rolls-info" style="margin-left:18px;"></span>
      </div>

      <!-- –ñ–∏–≤–æ–π –æ–±—â–∏–π —Å—á—ë—Ç -->
      <div id="live-total" class="turn-panel"></div>

      <div id="possible-moves" class="msg"></div>
      <table class="score-table" id="score-table"></table>
      <div id="game-msg" class="msg"></div>
      <div id="final-block" class="hide finish"></div>
    </div>

    <div id="records" class="tab-content">
      <h2 style="color:#2980b9;text-align:center;">üèÜ –†–µ–∫–æ—Ä–¥—ã –∏–≥—Ä–æ–∫–æ–≤</h2>
      <div id="records-wrap" class="msg">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <!-- Firebase compat SDKs (—Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ —Å–±–æ—Ä–∫–∏) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ---------- Tabs ---------- */
function showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  if(tab === 'game') document.querySelector('.tab-btn').classList.add('active');
  else document.querySelectorAll('.tab-btn')[1].classList.add('active');
  document.getElementById(tab).classList.add('active');
  if (tab === 'records') drawLeaderboard(); // –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
}

/* ---------- Game logic ---------- */
const upperFields = ["1","2","3","4","5","6"];
const lowerFields = ["–ü–∞—Ä–∞","–î–≤–µ –ø–∞—Ä—ã","–°–µ—Ç","–ö–∞—Ä–µ","–§—É–ª–ª —Ö–∞—É—Å","–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç","–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç","–Ø–¥–∑–∏","–®–∞–Ω—Å"];
const allFields = [...upperFields, ...lowerFields];

let scoreTable = {};
let round = 1, totalScore = 0, rollsLeft = 3;
let dice = [1,1,1,1,1];
let diceKeep = [false,false,false,false,false];
let roundScoreTables = [{}, {}, {}];

let playerName = "";

function startGameWithName() {
  const nameInput = document.getElementById("player-name").value.trim();
  if (!nameInput) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
  playerName = nameInput;
  document.getElementById("name-modal").style.display = "none";
  startRound();
}

function resetScoreTable(){ scoreTable = {}; for (let f of allFields) scoreTable[f] = null; }
function randomDice(){ return Math.floor(Math.random()*6)+1; }
function diceEmoji(v){ return ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][v-1]; }

function drawDiceRow(){
  const dr = document.getElementById("dice-row");
  dr.innerHTML = '';
  for(let i=0;i<5;i++){
    const d = document.createElement('div');
    d.className = 'dice' + (diceKeep[i] ? ' selected' : '');
    d.innerHTML = diceEmoji(dice[i]);
    d.onclick = () => {
      if (rollsLeft < 3 && rollsLeft > 0) { diceKeep[i] = !diceKeep[i]; drawDiceRow(); }
    };
    dr.appendChild(d);
  }
}
function rollDice(){ for(let i=0;i<5;i++) if(!diceKeep[i]) dice[i]=randomDice(); drawDiceRow(); }
function animateRoll(cb){
  let t = 10;
  const it = setInterval(()=>{
    for(let i=0;i<5;i++) if(!diceKeep[i]) dice[i]=randomDice();
    drawDiceRow();
    if(--t===0){ clearInterval(it); cb&&cb(); }
  },60);
}
function countDice(arr){ const c={1:0,2:0,3:0,4:0,5:0,6:0}; for(const d of arr) c[d]++; return c; }

function possibleScores(dice, table){
  const d = countDice(dice);
  const res = {};
  for(const f of upperFields) if(table[f]===null) res[f] = d[+f]*(+f);
  if(table["–ü–∞—Ä–∞"]===null){ res["–ü–∞—Ä–∞"]=0; for(let i=6;i>=1;i--) if(d[i]>=2){res["–ü–∞—Ä–∞"]=dice.reduce((a,b)=>a+b,0);break;} }
  if(table["–î–≤–µ –ø–∞—Ä—ã"]===null){ let p=0; for(let i=1;i<=6;i++) if(d[i]>=2) p++; res["–î–≤–µ –ø–∞—Ä—ã"]=p>=2?dice.reduce((a,b)=>a+b,0):0; }
  if(table["–°–µ—Ç"]===null){ res["–°–µ—Ç"]=0; for(let i=6;i>=1;i--) if(d[i]>=3){res["–°–µ—Ç"]=dice.reduce((a,b)=>a+b,0);break;} }
  if(table["–ö–∞—Ä–µ"]===null){ res["–ö–∞—Ä–µ"]=0; for(let i=6;i>=1;i--) if(d[i]>=4){res["–ö–∞—Ä–µ"]=dice.reduce((a,b)=>a+b,0);break;} }
  if(table["–§—É–ª–ª —Ö–∞—É—Å"]===null){ let three=0,pair=0; for(let i=6;i>=1;i--){ if(d[i]==3) three=i; else if(d[i]==2) pair=i; } res["–§—É–ª–ª —Ö–∞—É—Å"]=(three&&pair)?25:0; }
  if(table["–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç"]===null){ const u=[...new Set(dice)].sort((a,b)=>a-b); const has=[[1,2,3,4],[2,3,4,5],[3,4,5,6]].some(s=>s.every(x=>u.includes(x))); res["–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç"]=has?30:0; }
  if(table["–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç"]===null){ const has=[1,2,3,4,5].every(x=>dice.includes(x))||[2,3,4,5,6].every(x=>dice.includes(x)); res["–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç"]=has?40:0; }
  if(table["–Ø–¥–∑–∏"]===null){ res["–Ø–¥–∑–∏"]=Object.values(d).includes(5)?50:0; }
  if(table["–®–∞–Ω—Å"]===null){ res["–®–∞–Ω—Å"]=dice.reduce((a,b)=>a+b,0); }
  return res;
}

function calcRoundTotals(upperSums){
  const totals=[];
  for(let r=0;r<3;r++){
    let sum=0; for(const f of allFields) sum += roundScoreTables[r][f] || 0;
    if(upperSums[r] >= 63) sum += 35;
    totals[r]=sum;
  }
  return totals;
}

function drawTable(){
  const table = document.getElementById("score-table");
  let html = `<tr><th>–ü–æ–ª–µ</th><th>–†–∞—É–Ω–¥ 1</th><th>–†–∞—É–Ω–¥ 2</th><th>–†–∞—É–Ω–¥ 3</th></tr>`;
  html += `<tr><th colspan="4">–í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫</th></tr>`;
  const upperSums=[0,0,0];

  for(const f of upperFields){
    html += `<tr><td>${f}</td>`;
    for(let r=0;r<3;r++){
      const val = roundScoreTables[r][f] ?? "";
      if(val!=="") upperSums[r]+=val;
      html += `<td${r+1===round?' style="background:#2ecc4022;"':''}>${val}</td>`;
    }
    html += `</tr>`;
    if(f==="6"){
      html += `<tr>
        <td><b>–°—É–º–º–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞</b></td>
        <td class="${upperSums[0] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[0]}</b></td>
        <td class="${upperSums[1] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[1]}</b></td>
        <td class="${upperSums[2] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[2]}</b></td>
      </tr>`;
      html += `<tr>
        <td><b>–ë–æ–Ω—É—Å (+35, –µ—Å–ª–∏ ‚â•63)</b></td>
        <td class="bonus">${upperSums[0]>=63?35:""}</td>
        <td class="bonus">${upperSums[1]>=63?35:""}</td>
        <td class="bonus">${upperSums[2]>=63?35:""}</td>
      </tr>`;
      let lowerSums=[0,0,0];
      for(let r=0;r<3;r++) for(const ff of lowerFields) lowerSums[r]+=roundScoreTables[r][ff] ?? 0;
      html += `<tr>
        <td><b>–°—É–º–º–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞</b></td>
        <td><b>${lowerSums[0]}</b></td>
        <td><b>${lowerSums[1]}</b></td>
        <td><b>${lowerSums[2]}</b></td>
      </tr>`;
    }
  }

  html += `<tr><th colspan="4">–ù–∏–∂–Ω–∏–π –±–ª–æ–∫</th></tr>`;
  for(const f of lowerFields){
    html += `<tr><td>${f}</td>`;
    for(let r=0;r<3;r++){
      const val = roundScoreTables[r][f] ?? "";
      html += `<td${r+1===round?' style="background:#2ecc4022;"':''}>${val}</td>`;
    }
    html += `</tr>`;
  }

  html += `<tr><td><b>–ò—Ç–æ–≥–æ –∑–∞ —Ä–∞—É–Ω–¥</b>

