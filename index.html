<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–Ø–¥–∑–∏ (Yahtzee) - Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; background: #2c3e50; color: #fff; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 0 auto; padding: 26px; }
    h1 { text-align: center; margin-bottom: 12px;}
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 8px; }
    .tab-btn {
      background: #fff; color: #2980b9; border: none; padding: 10px 32px;
      border-radius: 7px 7px 0 0; cursor: pointer; font-size: 1.05em;
      border-bottom: 2px solid #eee; margin-bottom: -2px;
      transition: background 0.2s, color 0.2s;
    }
    .tab-btn.active { background: #2980b9; color: #fff; border-bottom: 2px solid #2980b9; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .top-actions { display:flex; justify-content:flex-end; align-items:center; gap: 10px; margin: 8px 0 14px; }
    .top-actions .btn { padding: 8px 16px; font-size: 0.98em; }

    .dice-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 18px;}
    .dice { width: 60px; height: 60px; background: #fff; color: #222; border-radius: 14px; box-shadow: 0 2px 8px #0004; display: flex; align-items: center; justify-content: center; font-size: 2.7rem; cursor: pointer; border: 3px solid transparent; transition: border 0.2s;}
    .dice.selected { border: 3px solid #27ae60;}
    .score-table { margin: 16px auto; max-width: 720px; border-collapse: collapse; background:#fff; color:#000;}
    .score-table th, .score-table td { border: 1px solid #666; padding: 7px 14px; text-align: center;}
    .score-table th { background: #34495e; color:#fff;}
    .score-table .available { cursor: pointer; background: #23aaff44;}
    .score-table .bonus { background: #39b54a99; color:#fff;}
    .btn { background: #2980b9; color: #fff; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-size: 1.05rem; transition: background 0.2s;}
    .btn[disabled] { background: #666; cursor: not-allowed;}
    .turn-panel { text-align: center; margin: 13px 0 23px;}
    .msg { text-align: center; margin-bottom: 18px; font-size: 1.05rem;}
    .hide { display: none; } .finish { background: #3c990f; color: #fff; padding: 24px 12px; border-radius: 16px; text-align: center; font-size: 1.5rem; margin: 20px;}
    @media (max-width: 700px) {
      .container { padding: 10px; }
      .score-table { font-size: 0.95em;}
      .dice { width: 44px; height: 44px; font-size: 1.8em;}
      .tab-btn { padding: 8px 12px; font-size: 0.95em;}
      .top-actions { justify-content:center; }
    }
    /* modal */
    #name-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:#000b;display:flex;align-items:center;justify-content:center;z-index:9999;}
    #name-modal .card {background:#fff;color:#000;padding:20px 30px;border-radius:12px;text-align:center;max-width: 90%;}
    #name-modal input {padding:10px;width:240px;font-size:1rem;}
    /* –∑–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—É–º–º—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ –ø—Ä–∏ –±–æ–Ω—É—Å–µ */
    .upper-bonus { background:#2ecc40 !important; color:#fff !important; }

    /* toast */
    #toast {position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); background: #000c; color: #fff; padding: 10px 14px; border-radius: 8px; display:none;}
  </style>
</head>
<body>
  <div id="name-modal">
    <div class="card">
      <h2>–í–≤–µ–¥–∏—Ç–µ –∏–º—è</h2>
      <input type="text" id="player-name" placeholder="–í–∞—à–µ –∏–º—è">
      <br><br>
      <button onclick="startGameWithName()" class="btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <div class="container">
    <h1>–Ø–¥–∑–∏ (Yahtzee) Web</h1>

    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('game')">–ò–≥—Ä–∞</button>
      <button class="tab-btn" onclick="showTab('records')">–†–µ–∫–æ—Ä–¥—ã</button>
    </div>

    <div class="top-actions">
      <button id="save-btn" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </div>

    <div id="game" class="tab-content active">
      <div id="round-info" class="turn-panel"></div>
      <div id="dice-row" class="dice-row"></div>
      <div style="text-align:center">
        <button id="roll-btn" class="btn">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫–∏</button>
        <span id="rolls-info" style="margin-left:18px;"></span>
      </div>
      <div id="possible-moves" class="msg"></div>
      <table class="score-table" id="score-table"></table>
      <div id="game-msg" class="msg"></div>
      <div id="final-block" class="hide finish"></div>
    </div>

    <div id="records" class="tab-content">
      <h2 style="color:#2980b9;text-align:center;">üèÜ –†–µ–∫–æ—Ä–¥—ã –∏–≥—Ä–æ–∫–æ–≤</h2>
      <div id="records-wrap" class="msg">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <div id="toast"></div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ---------- Tabs ----------
function showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  if(tab === 'game') document.querySelector('.tab-btn').classList.add('active');
  else document.querySelectorAll('.tab-btn')[1].classList.add('active');
  document.getElementById(tab).classList.add('active');
  if (tab === 'records') ensureLeaderboardSubscribed();
}

// ---------- Game logic (–∫–æ—Ä–æ—Ç–∫–æ, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞) ----------
const upperFields = ["1", "2", "3", "4", "5", "6"];
const lowerFields = ["–ü–∞—Ä–∞","–î–≤–µ –ø–∞—Ä—ã","–°–µ—Ç","–ö–∞—Ä–µ","–§—É–ª–ª —Ö–∞—É—Å","–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç","–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç","–Ø–¥–∑–∏","–®–∞–Ω—Å"];
const allFields = [...upperFields, ...lowerFields];
let scoreTable = {}; let round = 1, rollsLeft = 3;
let dice = [1,1,1,1,1]; let diceKeep = [false,false,false,false,false];
let roundScoreTables = [{}, {}, {}]; let playerName = "";
function startGameWithName(){ const v=document.getElementById('player-name').value.trim(); if(!v){alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');return;} playerName=v; document.getElementById('name-modal').style.display='none'; startRound(); }
function resetScoreTable(){ scoreTable={}; for(let f of allFields) scoreTable[f]=null; }
function randomDice(){ return Math.floor(Math.random()*6)+1; }
function diceEmoji(v){ return ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][v-1]; }
function drawDiceRow(){ const dr=document.getElementById('dice-row'); dr.innerHTML=''; for(let i=0;i<5;i++){ const d=document.createElement('div'); d.className='dice'+(diceKeep[i]?' selected':''); d.innerHTML=diceEmoji(dice[i]); d.onclick=()=>{ if(rollsLeft<3&&rollsLeft>0){ diceKeep[i]=!diceKeep[i]; drawDiceRow(); } }; dr.appendChild(d);} }
function animateRoll(cb){ let t=10; const int=setInterval(()=>{ for(let i=0;i<5;i++) if(!diceKeep[i]) dice[i]=randomDice(); drawDiceRow(); if(--t==0){ clearInterval(int); cb&&cb(); } },60); }
function countDice(a){ const c={1:0,2:0,3:0,4:0,5:0,6:0}; for(const d of a) c[d]++; return c; }
function possibleScores(d, table){ const c=countDice(d); const r={}; for(const f of upperFields) if(table[f]===null) r[f]=c[+f]*(+f);
  if(table["–ü–∞—Ä–∞"]===null){ r["–ü–∞—Ä–∞"]=0; for(let i=6;i>=1;i--) if(c[i]>=2){ r["–ü–∞—Ä–∞"]=d.reduce((a,b)=>a+b,0); break;} }
  if(table["–î–≤–µ –ø–∞—Ä—ã"]===null){ let p=0; for(let i=1;i<=6;i++) if(c[i]>=2) p++; r["–î–≤–µ –ø–∞—Ä—ã"]=p>=2?d.reduce((a,b)=>a+b,0):0; }
  if(table["–°–µ—Ç"]===null){ r["–°–µ—Ç"]=0; for(let i=6;i>=1;i--) if(c[i]>=3){ r["–°–µ—Ç"]=d.reduce((a,b)=>a+b,0); break;} }
  if(table["–ö–∞—Ä–µ"]===null){ r["–ö–∞—Ä–µ"]=0; for(let i=6;i>=1;i--) if(c[i]>=4){ r["–ö–∞—Ä–µ"]=d.reduce((a,b)=>a+b,0); break;} }
  if(table["–§—É–ª–ª —Ö–∞—É—Å"]===null){ let three=0,pair=0; for(let i=6;i>=1;i--){ if(c[i]==3) three=i; else if(c[i]==2) pair=i;} r["–§—É–ª–ª —Ö–∞—É—Å"]=(three&&pair)?25:0; }
  if(table["–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç"]===null){ const u=[...new Set(d)].sort((a,b)=>a-b); const has=[[1,2,3,4],[2,3,4,5],[3,4,5,6]].some(seq=>seq.every(x=>u.includes(x))); r["–ú–∞–ª—ã–π —Å—Ç—Ä–∏—Ç"]=has?30:0; }
  if(table["–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç"]===null){ const has=[1,2,3,4,5].every(x=>d.includes(x))||[2,3,4,5,6].every(x=>d.includes(x)); r["–ë–æ–ª—å—à–æ–π —Å—Ç—Ä–∏—Ç"]=has?40:0; }
  if(table["–Ø–¥–∑–∏"]===null){ r["–Ø–¥–∑–∏"]=Object.values(c).includes(5)?50:0; }
  if(table["–®–∞–Ω—Å"]===null){ r["–®–∞–Ω—Å"]=d.reduce((a,b)=>a+b,0); } return r;
}
function drawTable(){
  let html = `<tr><th>–ü–æ–ª–µ</th><th>–†–∞—É–Ω–¥ 1</th><th>–†–∞—É–Ω–¥ 2</th><th>–†–∞—É–Ω–¥ 3</th></tr>`;
  html += `<tr><th colspan="4">–í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫</th></tr>`;
  const upperSums=[0,0,0];
  for(const f of upperFields){
    html+=`<tr><td>${f}</td>`;
    for(let r=0;r<3;r++){
      const v=roundScoreTables[r][f]??"";
      if(v!=="") upperSums[r]+=v;
      html+=`<td${r+1===round?' style="background:#2ecc4022;"':''}>${v}</td>`;
    }
    html+='</tr>';
    if(f==='6'){
      // –°—É–º–º–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ + –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —è—á–µ–π–∫–∏, –µ—Å–ª–∏ –±–æ–Ω—É—Å —Å—Ä–∞–±–æ—Ç–∞–ª
      html+=`<tr>
        <td><b>–°—É–º–º–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞</b></td>
        <td class="${upperSums[0] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[0]}</b></td>
        <td class="${upperSums[1] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[1]}</b></td>
        <td class="${upperSums[2] >= 63 ? 'upper-bonus' : ''}"><b>${upperSums[2]}</b></td>
      </tr>`;
      // –ë–æ–Ω—É—Å —Å—Ç—Ä–æ–∫–∞ (–∑–µ–ª—ë–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –∫–∞–∫ –Ω–∞ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–Ω–µ)
      html+=`<tr>
        <td><b>–ë–æ–Ω—É—Å (+35, –µ—Å–ª–∏ ‚â•63)</b></td>
        <td class="bonus">${upperSums[0] >= 63 ? 35 : ''}</td>
        <td class="bonus">${upperSums[1] >= 63 ? 35 : ''}</td>
        <td class="bonus">${upperSums[2] >= 63 ? 35 : ''}</td>
      </tr>`;
      // –°—É–º–º–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞
      const lower=[0,0,0];
      for(let r=0;r<3;r++) for(const ff of lowerFields) lower[r]+=roundScoreTables[r][ff]??0;
      html+=`<tr>
        <td><b>–°—É–º–º–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞</b></td>
        <td><b>${lower[0]}</b></td>
        <td><b>${lower[1]}</b></td>
        <td><b>${lower[2]}</b></td>
      </tr>`;
    }
  }
  // –ù–∏–∂–Ω–∏–π –±–ª–æ–∫
  html += `<tr><th colspan="4">–ù–∏–∂–Ω–∏–π –±–ª–æ–∫</th></tr>`;
  for(const f of lowerFields){
    html+=`<tr><td>${f}</td>`;
    for(let r=0;r<3;r++){
      const v=roundScoreTables[r][f]??"";
      html+=`<td${r+1===round?' style="background:#2ecc4022;"':''}>${v}</td>`;
    }
    html+='</tr>';
  }
  // –ò—Ç–æ–≥–æ –∑–∞ —Ä–∞—É–Ω–¥
  html += `<tr><td><b>–ò—Ç–æ–≥–æ –∑–∞ —Ä–∞—É–Ω–¥</b></td>`;
  const totals=[];
  for(let r=0;r<3;r++){
    let s=0; for(const f of allFields) s+=roundScoreTables[r][f]||0;
    if(upperSums[r] >= 63) s+=35;
    totals[r]=s;
    html+=`<td><b>${s||""}</b></td>`;
  }
  html+='</tr>';
  // –û–±—â–∏–π —Å—á—ë—Ç (—Ä–µ–∞–ª-—Ç–∞–π–º), –±–µ–∑ "–æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –ø–æ–±–µ–¥—ã"
  const totalAll = totals.reduce((a,b)=>a+b,0);
  html += `<tr>
    <td colspan="4" style="text-align:right;">
      <b>–û–±—â–∏–π —Å—á—ë—Ç: ${totalAll}</b>
    </td>
  </tr>`;
  document.getElementById('score-table').innerHTML=html;
}
  html += `<tr><th colspan="4">–ù–∏–∂–Ω–∏–π –±–ª–æ–∫</th></tr>`;
  for(const f of lowerFields){ html+=`<tr><td>${f}</td>`; for(let r=0;r<3;r++){ const v=roundScoreTables[r][f]??""; html+=`<td${r+1===round?' style="background:#2ecc4022;"':''}>${v}</td>`;} html+='</tr>'; }
  html += `<tr><td><b>–ò—Ç–æ–≥–æ –∑–∞ —Ä–∞—É–Ω–¥</b></td>`;
  const totals=[]; for(let r=0;r<3;r++){ let s=0; for(const f of allFields) s+=roundScoreTables[r][f]||0; if(upperSums[r]>=63) s+=35; totals[r]=s; html+=`<td><b>${s||""}</b></td>`; } html+='</tr>';
  document.getElementById('score-table').innerHTML=html;
}
function showPossibleMoves(poss){ const arr=Object.entries(poss).filter(([k,v])=>scoreTable[k]===null); if(!arr.length) return ""; let html="<b>–í—ã–±–µ—Ä–∏ –∫—É–¥–∞ –∑–∞–ø–∏—Å–∞—Ç—å:</b> "; html+=arr.map(([k,v])=>`<span class="available" onclick="chooseField('${k}')">${k} <b>(${v})</b></span>`).join(' | '); document.getElementById('possible-moves').innerHTML=html; }
function hidePossibleMoves(){ document.getElementById('possible-moves').innerHTML=""; }
function chooseField(field){ const poss=possibleScores(dice,scoreTable); if(scoreTable[field]!==null) return; scoreTable[field]=poss[field]; roundScoreTables[round-1][field]=poss[field]; drawTable(); hidePossibleMoves(); const finished=allFields.every(f=>scoreTable[f]!==null); rollsLeft=3; diceKeep=[false,false,false,false,false]; document.getElementById('roll-btn').disabled=false; document.getElementById('rolls-info').innerHTML=""; document.getElementById('game-msg').innerHTML=""; drawDiceRow(); if(finished){ document.getElementById('game-msg').innerHTML=`<b>–†–∞—É–Ω–¥ ${round} –∑–∞–≤–µ—Ä—à—ë–Ω!</b>`; setTimeout(()=>{ if(round<3){ round++; startRound(); } else { showFinal(); } },1200);} }
function startRound(){ resetScoreTable(); rollsLeft=3; dice=[1,1,1,1,1]; diceKeep=[false,false,false,false,false]; document.getElementById('final-block').classList.add('hide'); document.getElementById('round-info').innerHTML=`<b>–†–∞—É–Ω–¥ ${round} –∏–∑ 3</b>`; document.getElementById('game-msg').innerHTML=""; drawDiceRow(); drawTable(); hidePossibleMoves(); document.getElementById('roll-btn').disabled=false; document.getElementById('rolls-info').innerHTML='–ë—Ä–æ—Å–∫–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: <b>3</b>'; }
function getCurrentTotal(){ const upper=[0,0,0]; for(let r=0;r<3;r++) for(const f of upperFields) upper[r]+=roundScoreTables[r][f]??0; const totals=[]; for(let r=0;r<3;r++){ let s=0; for(const f of allFields) s+=roundScoreTables[r][f]||0; if(upper[r]>=63) s+=35; totals[r]=s;} return totals.reduce((a,b)=>a+b,0); }
async function showFinal(){ const total=getCurrentTotal(); document.getElementById('final-block').classList.remove('hide'); document.getElementById('final-block').innerHTML=`<div>–í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç –∑–∞ 3 —Ä–∞—É–Ω–¥–∞: <b>${total}</b><br>${total>=777?"üéâ <b>–ü–û–ë–ï–î–ê!</b> üéâ":"üò¢ –ù–µ —Ö–≤–∞—Ç–∏–ª–æ –æ—á–∫–æ–≤ –¥–æ 777.<br>–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!"}<br><br><b>–ù–µ –∑–∞–±—É–¥—å –Ω–∞–∂–∞—Ç—å ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª (–∫–Ω–æ–ø–∫–∞ —Å–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞).</b><br><br><button class="btn" onclick="restartGame()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`; ensureLeaderboardSubscribed(); }
window.restartGame=function(){ round=1; roundScoreTables=[{},{},{}]; startRound(); }
document.getElementById('roll-btn').onclick=function(){ if(rollsLeft>0){ document.getElementById('roll-btn').disabled=true; animateRoll(()=>{ rollsLeft--; document.getElementById('roll-btn').disabled=rollsLeft==0; document.getElementById('rolls-info').innerHTML=`–ë—Ä–æ—Å–∫–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: <b>${rollsLeft}</b>`; if(rollsLeft==0){ showPossibleMoves(possibleScores(dice,scoreTable)); document.getElementById('game-msg').innerHTML='–í—ã–±–µ—Ä–∏ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.'; } else { document.getElementById('game-msg').innerHTML='–í—ã–¥–µ–ª–∏ –∫—É–±–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞—Ç—å, –∑–∞—Ç–µ–º —Å–Ω–æ–≤–∞ –±—Ä–æ—Å–∞–π.'; } }); } };

// ---------- Firebase setup (compat) ----------
const firebaseConfig = {
  apiKey: "AIzaSyDJX6EdXi_24H80N0WPfdHjmMZ97xRjuQQ",
  authDomain: "yadzee-a6b2b.firebaseapp.com",
  databaseURL: "https://yadzee-a6b2b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "yadzee-a6b2b",
  storageBucket: "yadzee-a6b2b.appspot.com",
  messagingSenderId: "67079856385",
  appId: "1:67079856385:web:cbc043ecfa6081b9983b00",
  measurementId: "G-G3HHBM8BF1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function showToast(text){ const t=document.getElementById('toast'); t.textContent=text; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }

async function saveScoreToFirebase(name, score){
  const payload={ name, score, ts: Date.now() };
  try { await db.ref('scores').push(payload); showToast('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!'); }
  catch(e){ console.error('saveScore error', e); showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å –∏ –ø—Ä–∞–≤–∏–ª–∞ –ë–î.'); }
}

// –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
document.getElementById('save-btn').addEventListener('click', async ()=>{
  let name = playerName;
  if (!name) { name = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞:'); if (!name) return; playerName = name; document.getElementById('name-modal').style.display='none'; }
  const current = getCurrentTotal();
  if (current <= 0) { showToast('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∏–≥—Ä–∞–π –æ—á–∫–∏ :)'); return; }
  await saveScoreToFirebase(name, current);
});

// ---------- Leaderboard: LIVE subscription (–∫–ª—é—á–µ–≤–æ–µ –º–µ—Å—Ç–æ) ----------
let scoresSubscribed = false;
function ensureLeaderboardSubscribed(){
  if (scoresSubscribed) return;
  scoresSubscribed = true;

  // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ—Ç–Ω—é —É–∑–ª–æ–≤, –ø–æ—Ç–æ–º —Å–∞–º–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ score/ts
  const ref = db.ref('scores').limitToLast(200);
  const wrap = document.getElementById('records-wrap');
  wrap.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

  ref.on('value', (snap) => {
    const list = [];
    if (snap && snap.exists()) {
      snap.forEach((child) => {
        list.push(child.val());
      });
    }
    console.log('records loaded:', list.length);
    // –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ—á–∫–æ–≤, –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ ‚Äî –∫—Ç–æ —Ä–∞–Ω—å—à–µ –∑–∞–ø–∏—Å–∞–ª, —Ç–æ—Ç –≤—ã—à–µ
    list.sort((a,b) => (b.score|0) - (a.score|0) || (a.ts||0) - (b.ts||0));
    renderLeaderboard(list.slice(0, 50));
  }, (err)=>{
    console.error('leaderboard error', err);
    wrap.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤: ' + err.message;
  });
}

function renderLeaderboard(rows){
  const wrap=document.getElementById('records-wrap');
  if (!rows || rows.length===0){ wrap.innerHTML='–ï—â—ë –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—ã–º!'; return; }
  let html = "<table class='score-table'><tr><th>#</th><th>–ò–º—è</th><th>–û—á–∫–∏</th><th>–î–∞—Ç–∞</th></tr>";
  rows.forEach((r,i)=>{
    const when = r.ts ? new Date(r.ts).toLocaleString() : '';
    html += `<tr><td>${i+1}</td><td>${escapeHtml(r.name||'')}</td><td>${r.score||0}</td><td>${when}</td></tr>`;
  });
  html += "</table>";
  wrap.innerHTML = html;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

window.onload = () => { /* –∂–¥—ë–º –≤–≤–æ–¥ –∏–º–µ–Ω–∏ */ };
</script>
</body>
</html>
